<mat-card [ngClass]="cardClasses" class="product-card-item" 
     [class.out-of-stock]="(product.stockQuantity || 0) === 0"
     [class.featured]="product.featured"
     (mouseenter)="onMouseEnter()" 
     (mouseleave)="onMouseLeave()">

  <div class="product-card-header">
    <a [routerLink]="['/products', product.id]" class="product-image-link">
      <img mat-card-image [src]="currentDisplayImage" [alt]="product.name" 
           class="product-image" loading="lazy"
           (error)="onImageError($event)">
    </a>
    <!-- Badges -->
    <div class="badges-container">
      <div class="badge discount-badge" *ngIf="discountPercentage !== null && discountPercentage > 0">
        -{{ discountPercentage }}%
      </div>
      <div class="badge new-badge" *ngIf="isNew && showNewBadge">NEW</div>
      <div class="badge featured-badge" *ngIf="product?.featured && showFeaturedBadge">FEATURED</div>
      <div class="badge bestseller-badge" *ngIf="isBestSeller && showBestsellerBadge">BESTSELLER</div>
      <div class="badge sold-out-badge" *ngIf="(product?.stockQuantity || 0) === 0 && showSoldOutBadge">SOLD OUT</div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button mat-icon-button class="action-btn" 
              (click)="addToWishlistHandler($event)" 
              [disabled]="addingToWishlistState"
              matTooltip="Add to Wishlist" aria-label="Add to wishlist">
        <mat-icon>{{ (isInWishlist$ | async) ? 'favorite' : 'favorite_border' }}</mat-icon>
      </button>
      <button mat-icon-button class="action-btn" 
              (click)="viewProductHandler($event)"
              matTooltip="Quick View" aria-label="Quick view product">
        <mat-icon>visibility</mat-icon>
      </button>
      <button mat-icon-button class="action-btn" 
              (click)="compareProductHandler($event)"
              [matTooltip]="(isInCompare$ | async) ? 'Remove from compare' : 'Add to compare'" 
              aria-label="Compare product">
        <mat-icon>{{ (isInCompare$ | async) ? 'check_circle' : 'compare_arrows' }}</mat-icon>
      </button>
    </div>

    <!-- Image hover controls -->
    <div class="image-hover-controls" *ngIf="product?.images && (product.images?.length || 0) > 1 && showImageHoverControls">
      <button mat-icon-button class="hover-control prev" (click)="prevImage($event)" aria-label="Previous image">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button mat-icon-button class="hover-control next" (click)="nextImage($event)" aria-label="Next image">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
    
    <!-- Image Indicators -->
    <div class="image-indicators" *ngIf="product?.images && (product.images?.length || 0) > 1 && showImageIndicators">
      <span class="indicator-dot" 
            *ngFor="let image of product.images; let i = index"
            [class.active]="i === currentImageIndex"
            (click)="setImage(i, $event)"></span>
    </div>

    <!-- Stock Indicator -->
    <div class="stock-indicator" *ngIf="showStockIndicator && product?.stockQuantity !== undefined && (product?.stockQuantity || 0) > 0 && (product?.stockQuantity || 0) <= 10">
      <div class="stock-bar">
        <div class="stock-fill" [style.width.%]="((product.stockQuantity || 0) / 10) * 100"></div>
      </div>
      <span class="stock-text" *ngIf="product?.stockQuantity">Only {{product.stockQuantity}} left</span>
    </div>
  </div>

  <mat-card-content class="product-card-content">
    <div class="product-meta">
      <span class="product-brand" *ngIf="product?.brand">{{product.brand}}</span>
      <span class="product-category" *ngIf="product.category && product.category.name">{{product.category.name}}</span>
    </div>

    <a [routerLink]="['/products', product.id]" class="product-name-link">
      <h3 class="product-name" matTooltip="{{product.name}}">{{product.name}}</h3>
    </a>
    
    <div class="product-rating" *ngIf="showRating && product?.rating !== undefined && (product?.rating || 0) > 0">
      <app-star-rating 
        [rating]="product.rating || 0" 
        [reviewCount]="product.reviews?.length || 0"
        [readOnly]="true">
      </app-star-rating>
    </div>

    <div class="product-description" *ngIf="showShortDescription">
      <p>{{ product.description | truncate:80 }}</p>
    </div>

    <div class="product-price-container">
      <p class="product-price">
        <span class="current-price">{{ (product.discountPrice || product.price || 0) | currency:currencySymbol }}</span>
        <span class="regular-price" *ngIf="product?.regularPrice && product?.price && (product?.regularPrice || 0) > (product?.price || 0)">
          {{product.regularPrice | currency:currencySymbol}}
        </span>
        <span class="discount-amount savings" *ngIf="discountAmount !== null && discountAmount > 0"> <!-- Added class savings -->
          Save {{discountAmount | currency:currencySymbol}}
        </span>
      </p>
      <p class="price-per-unit" *ngIf="product?.unit && product?.unitQuantity && product?.price">
          {{(product.price / product.unitQuantity!) | currency:currencySymbol}}/{{product.unit}}
      </p>
    </div>

    <div class="product-features" *ngIf="showKeyFeatures && product?.keyFeatures && (product.keyFeatures?.length || 0) > 0">
      <span class="feature" *ngFor="let feature of (product.keyFeatures?.slice(0, 2) || [])">
        <mat-icon class="feature-icon">check_circle_outline</mat-icon> {{feature}}
      </span>
    </div>

    <div class="shipping-info" *ngIf="showShippingInfo">
      <div class="shipping-item" *ngIf="product?.freeShipping">
        <mat-icon>local_shipping</mat-icon> Free Shipping
      </div>
      <div class="shipping-item" *ngIf="product?.fastDelivery">
        <mat-icon>flash_on</mat-icon> Fast Delivery
      </div>
    </div>
  </mat-card-content>

  <mat-card-actions class="product-card-actions" [ngClass]="{'show-quantity': uiShowQuantitySelector}">
    <div class="main-actions">
      <button mat-flat-button color="primary" class="add-to-cart-btn" 
              (click)="addToCartHandler($event)" 
              [disabled]="(product.stockQuantity || 0) === 0 || addingToCart">
        <mat-icon *ngIf="!addingToCart">add_shopping_cart</mat-icon>
        <mat-progress-spinner *ngIf="addingToCart" mode="indeterminate" diameter="20"></mat-progress-spinner>
        <span *ngIf="!addingToCart">Add to Cart</span>
        <span *ngIf="addingToCart">Adding...</span>
      </button>
    </div>
    <div class="quantity-controls" *ngIf="uiShowQuantitySelector && (product?.stockQuantity || 0) > 0">
       <button mat-icon-button (click)="decrementQuantity($event)" [disabled]="selectedQuantity === 1">
        <mat-icon>remove</mat-icon>
      </button>
      <input type="number" class="quantity-input" 
             [(ngModel)]="selectedQuantity" 
             min="1" [max]="product.stockQuantity || 1" 
             (change)="onQuantityChange()" (click)="$event.stopPropagation()">
      <button mat-icon-button (click)="incrementQuantity($event)" [disabled]="selectedQuantity >= (product.stockQuantity || 1)">
        <mat-icon>add</mat-icon>
      </button>
    </div>
     <button mat-stroked-button class="buy-now-btn" 
            (click)="buyNowHandler($event)"
            [disabled]="(product.stockQuantity || 0) === 0">
      Buy Now
    </button>
  </mat-card-actions>
</mat-card>
